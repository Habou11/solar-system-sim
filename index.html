<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>태양계 시뮬레이션</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
  <style>
    body {
      margin: 0; overflow: hidden;
      background: black;
      color: white;
      font-family: 'Noto Sans', sans-serif, sans-serif;
      -webkit-user-select:none;
      -moz-user-select:none;
      -ms-user-select:none;
      user-select:none;
    }
    .ui-button {
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
      z-index: 1000;
    }
    .ui-button button {
      padding: 10px 16px;
      font-size: 14px;
      font-weight: bold;
      border: none;
      border-radius: 6px;
      background: #eee;
      cursor: pointer;
      transition: background 0.2s;
      user-select:none;
    }
    .ui-button button:hover {
      background: #ccc;
    }
    .zoom-control {
      position: fixed;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      z-index: 1000;
      background: rgba(255,255,255,0.85);
      padding: 10px;
      border-radius: 10px;
      user-select:none;
    }
    .zoom-control button {
      margin: 4px 0;
      width: 36px;
      height: 36px;
      font-size: 20px;
      font-weight: bold;
      border: none;
      border-radius: 6px;
      background: #fff;
      cursor: pointer;
    }
    .zoom-control input[type="range"] {
      writing-mode: bt-lr;
      -webkit-appearance: slider-vertical;
      width: 30px;
      height: 130px;
      margin: 8px 0;
    }
    /* 정보창 스타일 */
    #infoBox {
      position: fixed;
      top: 60px;
      left: 20px;
      width: 240px;
      background: rgba(255,255,255,0.95);
      color: black;
      border-radius: 10px;
      padding: 12px 16px 16px 16px;
      box-shadow: 0 0 15px rgba(255,255,255,0.3);
      user-select:none;
      cursor: default;
      z-index: 1100;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
    }
    #infoBox.show {
      opacity: 1;
      visibility: visible;
    }
    #infoBox h2 {
      margin: 0 0 8px 0;
      font-weight: 700;
      font-size: 18px;
    }
    #infoBox ul {
      padding-left: 18px;
      margin: 0;
      font-size: 14px;
      line-height: 1.3;
    }
    #infoBox ul li {
      margin-bottom: 6px;
    }
    #closeBtn {
      position: absolute;
      top: 8px;
      right: 12px;
      font-size: 20px;
      font-weight: bold;
      color: #444;
      cursor: pointer;
      user-select:none;
      transition: color 0.2s;
    }
    #closeBtn:hover {
      color: #000;
    }
    /* 배속 표시 스타일 (독립) */
    #speedDisplay {
      position: fixed;
      top: 20px;
      right: 20px;
      font-size: 14px;
      font-weight: bold;
      color: #333;
      background: rgba(255,255,255,0.85);
      padding: 6px 10px;
      border-radius: 5px;
      text-align: center;
      width: 80px;
      z-index: 1000;
    }
    /* 날짜 표시 스타일 */
    #dateDisplay {
      position: fixed;
      top: 60px; /* speedDisplay 아래에 위치 */
      right: 20px;
      font-size: 14px;
      font-weight: bold;
      color: #333;
      background: rgba(255,255,255,0.85);
      padding: 6px 10px;
      border-radius: 5px;
      text-align: center;
      width: 180px; /* 너비 조정 */
      z-index: 1000;
    }
  </style>
</head>
<body>

<div class="ui-button">
  <button id="pauseBtn">⏸ 정지</button>
  <button id="slowBtn">느리게</button>
  <button id="fastBtn">빠르게</button>
</div>

<div class="zoom-control">
  <button id="zoomInBtn">＋</button>
  <input type="range" min="0.5" max="2" step="0.01" value="1" id="zoomSlider" />
  <button id="zoomOutBtn">−</button>
</div>

<span id="speedDisplay">배속: x1.0</span>

<span id="dateDisplay">날짜: 2025년 01월 01일</span>

<div id="infoBox">
  <span id="closeBtn">×</span>
  <h2>행성 정보</h2>
  <ul id="infoContent"></ul>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
<script>
let planets = [];
let stars = [];
let selectedPlanet = null;
let baseSpeed = 0.5;
let displaySpeed = 1;
let maxDisplaySpeed = 4;
let currentSpeed = baseSpeed;
let isPaused = false;

// 카메라 관련 변수 추가
let camX = 0; // 현재 카메라 X 위치
let camY = 0; // 현재 카메라 Y 위치
let targetCamX = 0; // 목표 카메라 X 위치
let targetCamY = 0; // 목표 카메라 Y 위치
let zoom = 1; // 현재 확대/축소 배율
let targetZoom = 1; // 목표 확대/축소 배율
let isFollowingPlanet = false; // 행성 추적 중인지 여부
let cameraEaseFactor = 0.08; // 카메라 이동 부드러움 정도 (0.01~0.1 정도)
let defaultZoom = 1; // 기본 줌 레벨 (슬라이더로 조절됨)
let focusedPlanetZoom = 2; // 행성 포커싱 시 줌 레벨

// 날짜 관련 변수 추가
let currentDate; // 현재 시뮬레이션 날짜 Date 객체
let daysPerSimulatedFrame = 0.05; // 1 프레임당 지나가는 시뮬레이션 일수 (배속 1 기준)

let infoBox = null;
let infoContent = null;
let speedDisplay = null;
let dateDisplay = null; // 날짜 표시 요소
let infoBoxX = 20, infoBoxY = 60;
let draggingInfo = false;
let dragOffsetX = 0, dragOffsetY = 0;

function setup() {
  createCanvas(windowWidth, windowHeight);
  angleMode(DEGREES);
  initPlanets();
  generateStars();

  infoBox = document.getElementById('infoBox');
  infoContent = document.getElementById('infoContent');
  speedDisplay = document.getElementById('speedDisplay');
  dateDisplay = document.getElementById('dateDisplay'); // 날짜 표시 요소 가져오기

  // 날짜 초기화 (2025년 1월 1일로 시작)
  currentDate = new Date('2025-01-01T00:00:00');

  // 버튼 이벤트 연결
  document.getElementById('pauseBtn').addEventListener('click', togglePause);
  document.getElementById('slowBtn').addEventListener('click', () => adjustSpeed(-0.1));
  document.getElementById('fastBtn').addEventListener('click', () => adjustSpeed(0.1));
  document.getElementById('zoomInBtn').addEventListener('click', () => setZoom(defaultZoom * 1.1));
  document.getElementById('zoomOutBtn').addEventListener('click', () => setZoom(defaultZoom / 1.1));
  document.getElementById('zoomSlider').addEventListener('input', (e) => setZoom(parseFloat(e.target.value)));
  // 'x' 버튼 클릭 이벤트 리스너 수정: event.stopPropagation() 추가
  document.getElementById('closeBtn').addEventListener('click', (event) => {
    event.stopPropagation(); // 이벤트 전파 중지
    closeInfoBox();
  });

  // 드래그 시작
  infoBox.addEventListener('mousedown', infoMouseDown);
  window.addEventListener('mouseup', infoMouseUp);
  window.addEventListener('mousemove', infoMouseMove);

  // 터치 지원
  infoBox.addEventListener('touchstart', infoTouchStart, {passive: false});
  window.addEventListener('touchend', infoTouchEnd);
  window.addEventListener('touchmove', infoTouchMove, {passive: false});

  updateSpeedDisplay(); // 초기 배속 표시
  updateDateDisplay(); // 초기 날짜 표시
}

function draw() {
  background(0);
  drawStars();

  // 날짜 업데이트
  if (!isPaused) {
    currentDate.setDate(currentDate.getDate() + daysPerSimulatedFrame * currentSpeed);
    updateDateDisplay();
  }

  // 카메라 업데이트 로직
  if (isFollowingPlanet && selectedPlanet) {
    targetCamX = -selectedPlanet.x; // 행성 위치를 화면 중앙으로 가져오기 위해 반대 방향으로 이동
    targetCamY = -selectedPlanet.y;
    targetZoom = focusedPlanetZoom;
  } else {
    targetCamX = 0; // 태양을 중심으로
    targetCamY = 0;
    targetZoom = defaultZoom; // 기본 줌 레벨 사용
  }

  // 카메라 위치와 줌 부드럽게 보간
  camX = lerp(camX, targetCamX, cameraEaseFactor);
  camY = lerp(camY, targetCamY, cameraEaseFactor);
  zoom = lerp(zoom, targetZoom, cameraEaseFactor);

  // 카메라 변환 적용 (translate, scale 순서 중요)
  translate(width / 2 + camX * zoom, height / 2 + camY * zoom);
  scale(zoom);

  let targetSpeed = isPaused ? 0 : baseSpeed * displaySpeed;
  currentSpeed = lerp(currentSpeed, targetSpeed, 0.05);

  noFill();
  stroke(100, 150);
  strokeWeight(1);
  for (let p of planets) {
    // 태양은 궤도를 그리지 않음
    if (p.orbit > 0) ellipse(0, 0, p.orbit * 2);
  }

  for (let p of planets) {
    if (p.orbit > 0) p.angle += p.speed * currentSpeed;
    let x = p.orbit === 0 ? 0 : cos(p.angle) * p.orbit;
    let y = p.orbit === 0 ? 0 : sin(p.angle) * p.orbit;
    p.x = x;
    p.y = y;

    // 할로 효과
    noStroke();
    for(let i=0; i<5; i++) {
      fill(p.color[0], p.color[1], p.color[2], 80 - i*15);
      ellipse(x, y, p.size*2 + i*10);
    }

    fill(p.color[0], p.color[1], p.color[2]);
    ellipse(x, y, p.size * 2);

    fill(255);
    stroke(0);
    strokeWeight(3);
    // 줌에 따라 텍스트 크기 조절
    textSize(12 / (zoom / defaultZoom)); // 기본 줌에 대한 상대적인 크기 유지
    textAlign(CENTER);
    text(p.name, x, y - p.size - 8);
    noStroke();
  }

  // 정보창 드래그중이라면 스타일 업데이트 (선택된 행성 있음)
  if (infoBox.classList.contains('show')) {
      infoBox.style.left = infoBoxX + 'px';
      infoBox.style.top = infoBoxY + 'px';
  }
}

function initPlanets() {
  planets = [];
  // 태양 (중심)
  planets.push({
    name: "태양", orbit: 0, size: 50, speed: 0, angle: 0,
    color: [255, 220, 0],
    info: {
      반지름: "696,340 km",
      성분: "수소, 헬륨",
      대기: "있음",
      위성: "없음",
      기원: "Sol"
    }
  });

  const data = [
    { name: "수성", orbit: 90, size: 6, speed: 4.8, color: [128,128,128], info: { 반지름: "2,439 km", 성분: "암석", 대기: "거의 없음", 위성: "없음", 기원: "헤르메스" }},
    { name: "금성", orbit: 120, size: 10, speed: 3.5, color: [255,165,0], info: { 반지름: "6,052 km", 성분: "암석", 대기: "CO2", 위성: "없음", 기원: "비너스" }},
    { name: "지구", orbit: 160, size: 12, speed: 3, color: [0, 102, 204], info: { 반지름: "6,371 km", 성분: "암석", 대기: "질소, 산소", 위성: "달 1개", 기원: "Earth" }},
    { name: "화성", orbit: 200, size: 9, speed: 2.4, color: [204, 0, 0], info: { 반지름: "3,390 km", 성분: "암석", 대기: "이산화탄소", 위성: "2개", 기원: "마르스" }},
    { name: "목성", orbit: 250, size: 20, speed: 1.3, color: [255,140,0], info: { 반지름: "69,911 km", 성분: "가스", 대기: "수소, 헬륨", 위성: "92개", 기원: "주피터" }},
    { name: "토성", orbit: 300, size: 18, speed: 1.0, color: [240,230,140], info: { 반지름: "58,232 km", 성분: "가스", 대기: "수소, 헬륨", 위성: "83개", 기원: "크로노스" }},
    { name: "천왕성", orbit: 350, size: 16, speed: 0.7, color: [173,216,230], info: { 반지름: "25,362 km", 성분: "가스", 대기: "수소, 헬륨, 메탄", 위성: "27개", 기원: "우라노스" }},
    { name: "해왕성", orbit: 400, size: 15, speed: 0.5, color: [0, 0, 255], info: { 반지름: "24,622 km", 성분: "가스", 대기: "수소, 헬륨, 메탄", 위성: "14개", 기원: "넵튠" }},
    { name: "명왕성", orbit: 440, size: 5, speed: 0.3, color: [192,192,192], info: { 반지름: "1,188 km", 성분: "얼음, 암석", 대기: "질소, 메탄", 위성: "5개", 기원: "플루토", 분류: "왜소행성" }},
  ];

  for (let p of data) {
    p.angle = random(360);
    planets.push(p);
  }
}

function generateStars() {
  stars = [];
  for (let i = 0; i < 400; i++) {
    stars.push({
      x: random(width),
      y: random(height),
      baseBrightness: random(180, 255),
      twinkle: random(0.01, 0.05),
      phase: random(TWO_PI)
    });
  }
}

function drawStars() {
  noStroke();
  for (let s of stars) {
    let flicker = sin(frameCount * s.twinkle + s.phase) * 30;
    let b = constrain(s.baseBrightness + flicker, 180, 255);
    fill(b);
    ellipse(s.x, s.y, 1.5);
  }
}

// 클릭 / 터치 이벤트로 행성 선택 및 정보창 출력
function mousePressed() {
  // 정보창 드래그 중이거나 정보창 내부 클릭 시, 행성 클릭 이벤트 무시
  if (checkInfoBoxHit(mouseX, mouseY) || draggingInfo) {
    return;
  }
  handleClick(mouseX, mouseY);
}
function touchStarted() {
  // 정보창 드래그 중이거나 정보창 내부 터치 시, 행성 터치 이벤트 무시
  if (checkInfoBoxHit(touchX, touchY) || draggingInfo) {
    return false;
  }
  handleClick(touchX, touchY);
  return false;
}

function handleClick(x, y) {
  let mx = (x - (width / 2 + camX * zoom)) / zoom; // 카메라 이동 및 줌 반영된 마우스 좌표
  let my = (y - (height / 2 + camY * zoom)) / zoom; // 카메라 이동 및 줌 반영된 마우스 좌표

  // 행성 클릭 감지
  for (let p of planets) {
    // 클릭 감지 시 행성 크기에 줌을 역으로 반영하여 클릭 영역 고정
    if (dist(mx, my, p.x, p.y) < p.size * 1.5 / (zoom / defaultZoom)) { // 클릭 반경도 줌에 맞춰 조절
      if (selectedPlanet === p) {
        // 이미 선택된 행성이면 정보창 닫고 팔로우 중지
        closeInfoBox();
      } else {
        selectedPlanet = p;
        showInfoBox(p);
        isFollowingPlanet = true; // 행성 팔로우 시작
      }
      return; // 행성을 클릭했으므로 다른 클릭 처리 중단
    }
  }

  // 행성 외 클릭시 정보창 닫기 (선택된 행성이 있을 경우만)
  if (selectedPlanet) {
    closeInfoBox();
  }
}

function showInfoBox(planet) {
  if (!planet) return;
  infoContent.innerHTML = "";
  let keys = Object.keys(planet.info);
  for (let k of keys) {
    let li = document.createElement('li');
    li.textContent = `${k}: ${planet.info[k]}`;
    infoContent.appendChild(li);
  }
  infoBox.querySelector('h2').textContent = `🌍 ${planet.name} 정보`;
  infoBox.classList.add('show');
  infoBox.style.left = infoBoxX + 'px';
  infoBox.style.top = infoBoxY + 'px';
  // selectedPlanet은 handleClick에서 이미 설정됨
}

function closeInfoBox() {
  selectedPlanet = null;
  infoBox.classList.remove('show');
  isFollowingPlanet = false; // 행성 팔로우 중지
  // targetCamX, targetCamY, targetZoom은 draw에서 자동으로 기본값으로 돌아감
}

// 드래그 시작
function infoMouseDown(e) {
  e.preventDefault();
  draggingInfo = true;
  dragOffsetX = e.clientX - infoBox.offsetLeft;
  dragOffsetY = e.clientY - infoBox.offsetTop;
}
// 드래그 중
function infoMouseMove(e) {
  if (!draggingInfo) return;
  e.preventDefault();
  infoBoxX = e.clientX - dragOffsetX;
  infoBoxY = e.clientY - dragOffsetY;
  infoBox.style.left = infoBoxX + 'px';
  infoBox.style.top = infoBoxY + 'px';
}
// 드래그 끝
function infoMouseUp(e) {
  draggingInfo = false;
}

// 터치 드래그 시작
function infoTouchStart(e) {
  if (e.touches.length !== 1) return;
  e.preventDefault();
  draggingInfo = true;
  let touch = e.touches[0];
  dragOffsetX = touch.clientX - infoBox.offsetLeft;
  dragOffsetY = touch.clientY - infoBox.offsetTop;
}
// 터치 드래그 중
function infoTouchMove(e) {
  if (!draggingInfo) return;
  e.preventDefault();
  let touch = e.touches[0];
  infoBoxX = touch.clientX - dragOffsetX;
  infoBoxY = touch.clientY - dragOffsetY;
  infoBox.style.left = infoBoxX + 'px';
  infoBox.style.top = infoBoxY + 'px';
}
// 터치 드래그 끝
function infoTouchEnd(e) {
  draggingInfo = false;
}

function togglePause() {
  isPaused = !isPaused;
  document.getElementById("pauseBtn").textContent = isPaused ? "▶ 재생" : "⏸ 정지";
}

function adjustSpeed(delta) {
  displaySpeed = constrain(displaySpeed + delta, 0.1, maxDisplaySpeed);
  updateSpeedDisplay();
}

function updateSpeedDisplay() {
  speedDisplay.textContent = `배속: x${displaySpeed.toFixed(1)}`;
}

// 날짜 표시 업데이트 함수
function updateDateDisplay() {
  const year = currentDate.getFullYear();
  const month = String(currentDate.getMonth() + 1).padStart(2, '0'); // 2자리로
  const day = String(currentDate.getDate()).padStart(2, '0'); // 2자리로
  dateDisplay.textContent = `날짜: ${year}년 ${month}월 ${day}일`;
}

function setZoom(val) {
  defaultZoom = constrain(val, 0.5, 2); // 슬라이더는 기본 줌을 조절
  document.getElementById("zoomSlider").value = defaultZoom;
  // 행성 팔로우 중이 아니라면, 현재 줌도 바로 업데이트
  if (!isFollowingPlanet) {
      zoom = defaultZoom;
  }
}

function windowResized() {
  resizeCanvas(windowWidth, windowHeight);
}

// 정보창이 클릭된 위치에 있는지 확인하는 함수 (드래그 시작 등)
function checkInfoBoxHit(x, y) {
  // 정보창이 보이지 않으면 충돌 체크하지 않음
  if (!infoBox.classList.contains('show')) return false;

  let rectLeft = infoBoxX;
  let rectTop = infoBoxY;
  let rectRight = rectLeft + infoBox.offsetWidth;
  let rectBottom = rectTop + infoBox.offsetHeight;
  return (x >= rectLeft && x <= rectRight && y >= rectTop && y <= rectBottom);
}
</script>
</body>
</html>
